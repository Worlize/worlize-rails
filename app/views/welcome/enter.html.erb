<!doctype html>  
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml" lang="en" xml:lang="en"> 
    <%
        if ::Rails.env == 'production' 
          path = '/client' 
        else
          path = '/flash'
        end
        
        cache_bust = '55'
    -%>
    <head>
        <meta name="google" value="notranslate" />         
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Worlize</title>         

        <style type="text/css" media="screen"> 
            html, body  { height:100%; overflow:hidden; }
            body { margin:0; padding:0;
                   background-color: #ffffff; }   
            object:focus { outline:none; }
            #flashContent { display:none; }
        </style>

        <link rel="stylesheet" href="/stylesheets/enter.css?cb=<%= cache_bust %>">
        <link rel="stylesheet" href="/stylesheets/main-fonts.css?cb=<%= cache_bust %>">
        <script type="text/javascript" src="/javascripts/swfobject.js"></script>

        <script>
          function configData() {
            return <%= @configJSON.html_safe %>;
          }
        </script>
    </head>
    <body>
      <div id="fb-root"></div>
      <script>
        window.fbLoggedIn = false;
      
        window.fbAsyncInit = function() {
          FB.init({
            appId  : '<%= Worlize.config['facebook']['app_id'] %>',
            status : true, // check login status
            cookie : true, // enable cookies to allow the server to access the session
            xfbml  : true,  // parse XFBML
            channelUrl  : '<%= escape_javascript("#{request.scheme}://#{request.host_with_port}/channel.html") %>', // Custom Channel URL
            oauth : true, //enables OAuth 2.0
            frictionlessRequests : true // Enable frictionless requests
          });
          
          var facebookLoginTimeoutHandler = function() {
            fbLoginTimeout = null;
            loadFlashApp();
          };

          var fbLoginTimeout = setTimeout(facebookLoginTimeoutHandler, 5000);
          
          // We want to make sure any potential facebook session is
          // initialized before we launch the application.  We'll wait up to
          // five seconds to get the login status response.
          FB.getLoginStatus(function(response) {
            if (fbLoginTimeout) {
              clearTimeout(fbLoginTimeout);

              if (response.authResponse) {
                window.fbLoggedIn = true;

                <% if current_user.facebook_authentication %>
                // Verify that the user's facebook account matches what we expect
                if (response.authResponse.userID !== "<%= current_user.facebook_authentication.uid %>") {
                  $.get('/logout.json', function() {
                    FB.logout(function(response) {
                      top.location.href = "/auth/facebook";
                    });
                  });
                  alert("This Worlize account is associated to a Facebook account " +
                        "other than the one that is currently logged in.  Click " +
                        "OK to log in to the correct Facebook account.");
                  return;
                }
                <% end %>

              }
              loadFlashApp();
            }
          });
        };
        
        requestedFacebookPermissions = '<%= escape_javascript(Worlize.config['facebook']['requested_permissions']) %>';

        (function() {
          var e = document.createElement('script');
          e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
          e.async = true;
          document.getElementById('fb-root').appendChild(e);
        }());

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-7700604-3']);
        _gaq.push(['_setDomainName', '.worlize.com']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

        function loadFlashApp() {
          // For version detection, set to min. required Flash Player version, or 0 (or 0.0.0), for no version detection. 
          var swfVersionStr = "10.2.0";
          // To use express install, set to playerProductInstall.swf, otherwise the empty string. 
          var xiSwfUrlStr = "<%= path %>/playerProductInstall.swf";
          var flashvars = {};
          var params = {};
          params.quality = "high";
          params.wmode = "opaque";
          params.bgcolor = "#e6e3dc";
          params.allowscriptaccess = "sameDomain";
          params.allowfullscreen = "true";
          var attributes = {};
          attributes.id = "FlashClient";
          attributes.name = "FlashClient";
          attributes.align = "middle";
          swfobject.embedSWF(
              "<%= path %>/FlashClient.swf?cb=<%= cache_bust %>", "flashContent", 
              "100%", "100%", 
              swfVersionStr, xiSwfUrlStr, 
              flashvars, params, attributes);
          // JavaScript enabled so display the flashContent div in case it is not replaced with a swf object.
          swfobject.createCSS("#flashContent", "display:block;text-align:left;");
        }
      </script>
      
      <div id="flashContent">
      	<p>
        	To view this page ensure that Adobe Flash Player version 
			    10.2.0 or greater is installed. 
		    </p>
      </div>
      
	    <!-- Javascript at the bottom for fast page loading -->
      <% if Rails.env == 'production' -%>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
        <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
      <%- else -%>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
        <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.js"%3E%3C/script%3E'))</script>
      <% end -%>
      
      <script src="/javascripts/enter.js?cb=<%= cache_bust %>" type="text/javascript" charset="utf-8"></script>
      
      <script src="/fancybox/jquery.fancybox-1.3.4.pack.js" type="text/javascript" charset="utf-8"></script>
      <link rel="stylesheet" href="/fancybox/jquery.fancybox-1.3.4.css" type="text/css" media="screen" />

      <div id="loading-overlay-container">
        <div id="loading-overlay">
          <div class="character"> </div>
          <p>Loading.  Please Wait...</p>
        </div>
      </div>

   </body>
</html>
